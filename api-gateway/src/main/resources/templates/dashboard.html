<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="utf-8" />
    <title>CloudCrush — Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root{
          --bg:#f7fbff;
          --card:#ffffff;
          --accent:#6ea8ff;
          --accent-2:#bda4ff;
          --muted:#6b7280;
          --text:#0f172a;
          --radius:14px;
          font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        }
        html,body{height:100%;margin:0;background:var(--bg);color:var(--text)}
        .wrap{max-width:1100px;margin:28px auto;padding:16px}
        header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
        .brand{display:flex;align-items:center;gap:14px}
        .logo{width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;font-weight:800;display:flex;align-items:center;justify-content:center;font-size:20px}
        h1{margin:0;font-size:22px}
        .muted{color:var(--muted);font-size:14px}
        .controls{display:flex;align-items:center;gap:12px}
        .card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 8px 30px rgba(18,38,63,0.06);border:1px solid rgba(109,115,255,0.04)}
        .controls-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        input[type=text],input[type=file]{padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);font-size:14px}
        .btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;cursor:pointer;font-weight:600}
        .btn.ghost{background:#fff;border:1px solid rgba(15,23,42,0.06);color:var(--text)}
        #status{margin-top:10px;color:var(--accent-2);font-weight:600}
        #files{margin-top:18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
        .file{background:#fff;border-radius:12px;padding:14px;border:1px solid rgba(15,23,42,0.04);box-shadow:0 8px 20px rgba(16,24,40,0.04)}
        .file h4{margin:0;font-size:15px}
        .meta{color:var(--muted);font-size:13px;margin-top:6px}
        .actions{display:flex;gap:8px;margin-top:10px}
        .action-download{background:linear-gradient(90deg,#7dd3fc,#60a5fa);border:0;padding:8px 10px;border-radius:10px;color:#fff;cursor:pointer}
        .action-delete{background:linear-gradient(90deg,#fda4af,#f78da7);border:0;padding:8px 10px;border-radius:10px;color:#fff;cursor:pointer}
        .notif{margin-top:12px;padding:10px;border-radius:8px;background:linear-gradient(90deg,rgba(110,168,255,0.08),rgba(189,164,255,0.06));border-left:4px solid var(--accent)}
        footer{margin-top:26px;text-align:center;color:var(--muted);font-size:13px}
        @media (max-width:720px){.wrap{padding:12px}.controls-row{flex-direction:column;align-items:stretch}}
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <div class="brand">
            <div class="logo">CC</div>
            <div>
                <h1>CloudCrush</h1>
                <div class="muted">Your personal alternative to Google Drive</div>
                <div class="muted">Because documents and memories both are important</div>
            </div>
        </div>

        <div class="controls">
            <div id="userEmail" class="muted">—</div>
            <button id="logoutBtn" class="btn ghost">Logout</button>
        </div>
    </header>

    <section class="card">
        <div class="controls-row">
            <input id="fileInput" type="file" />
            <button id="uploadBtn" class="btn">Upload</button>
            <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
                <input id="searchInput" type="text" placeholder="Search by filename..." />
                <button id="searchBtn" class="btn ghost">Search</button>
            </div>
        </div>

        <div id="status">Loading...</div>
        <div id="files"></div>

        <h3 style="margin-top:18px;color:var(--accent)">Notifications</h3>
        <div id="notifications"></div>
    </section>

    <footer>
        <div><strong>CloudCrush</strong> — your personal alternative to Google Drive • Founded by <span style="color:var(--accent-2);font-weight:700">Nandini Sharma</span></div>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<!-- JS kept compatible with your existing endpoints and token usage -->
<script>
    (function(){
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('token');
      if (tokenFromUrl) { localStorage.setItem('jwt', tokenFromUrl); window.history.replaceState({}, document.title, '/dashboard'); }

      const token = localStorage.getItem('cc_token') || localStorage.getItem('jwt') || localStorage.getItem('token') || localStorage.getItem('jwtToken');
      const AUTH_HEADER = token ? 'Bearer ' + token : null;

      const setStatus = (m, err=false) => {
        const el = document.getElementById('status'); el.textContent = m; el.style.color = err ? 'crimson' : 'var(--accent-2)';
      };

      if (!AUTH_HEADER) { alert('No JWT found. Please login.'); return (location.href='/login'); }

      const payload = (() => { try { const p = token.split('.')[1]; return JSON.parse(atob(p.replace(/-/g,'+').replace(/_/g,'/'))) } catch { return null } })();
      if (payload?.sub || payload?.email) document.getElementById('userEmail').textContent = payload.sub || payload.email;

      const escapeHtml = s => s ? s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) : '';

      async function fetchFiles(){
        setStatus('Loading files...');
        const res = await fetch('/api/metadata/my-files', { headers: { Authorization: AUTH_HEADER }});
        if (res.status===401||res.status===403){ setStatus('Unauthorized. Please login again.', true); localStorage.clear(); return location.href='/login'; }
        if (!res.ok) return setStatus('Failed: '+res.status, true);
        const files = await res.json();
        setStatus('Files loaded • ' + (files.length||0));
        renderFiles(files);
      }

      async function uploadFile(){
        const file = document.getElementById('fileInput').files[0];
        if (!file) return alert('Select a file');
        setStatus('Uploading...');
        const fd = new FormData(); fd.append('file', file);
        const res = await fetch('/api/metadata/upload', { method:'POST', headers:{ Authorization: AUTH_HEADER }, body: fd });
        if (!res.ok) return setStatus('Upload failed', true);
        await res.json().catch(()=>{});
        setStatus('Upload successful');
        fetchFiles();
      }

      async function deleteFile(name){
        if (!confirm('Delete ' + name + '?')) return;
        setStatus('Deleting...');
        const res = await fetch('/api/metadata/delete?filename=' + encodeURIComponent(name), { method:'DELETE', headers:{ Authorization: AUTH_HEADER }});
        if (!res.ok) return setStatus('Delete failed', true);
        setStatus('Deleted ' + name);
        fetchFiles();
      }

      async function downloadFile(name){
        setStatus('Downloading...');
        const res = await fetch('/api/metadata/download/' + encodeURIComponent(name), { headers:{ Authorization: AUTH_HEADER }});
        if (!res.ok) return setStatus('Download failed', true);
        const blob = await res.blob(); const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url);
        setStatus('Downloaded ' + name);
      }

      async function searchFiles(){
        const q = document.getElementById('searchInput').value.trim();
        if (!q) return fetchFiles();
        setStatus('Searching...');
        const res = await fetch('/api/metadata/search?query=' + encodeURIComponent(q), { headers:{ Authorization: AUTH_HEADER }});
        if (!res.ok) return setStatus('Search failed', true);
        const files = await res.json(); setStatus('Found ' + (files.length||0) + ' results'); renderFiles(files);
      }

      function renderFiles(files){
        const el = document.getElementById('files'); el.innerHTML = files && files.length ? '' : '<div class="muted">No files found.</div>';
        (files||[]).forEach(f => {
          const div = document.createElement('div'); div.className='file';
          const safe = (f.filename||'').replace(/'/g,"\\'");
          div.innerHTML = `<div><h4>${escapeHtml(f.filename)}</h4><div class="meta">${escapeHtml(f.owner||'')} • ${(f.size||0)/1024|0} KB</div></div>
            <div class="actions">
              <button class="action-download" onclick="downloadFile('${safe}')">Download</button>
              <button class="action-delete" onclick="deleteFile('${safe}')">Delete</button>
            </div>`;
          el.appendChild(div);
        });
      }

      // WebSocket notifications
      let stompClient=null;
      (function initWS(){
        try {
          const sock = new SockJS('/ws'); stompClient = Stomp.over(sock);
          stompClient.connect({}, ()=> {
            stompClient.subscribe('/topic/notifications', msg => {
              const d = document.createElement('div'); d.className='notif'; d.textContent = msg.body;
              document.getElementById('notifications').prepend(d);
              setStatus('Notification: ' + msg.body);
            });
          });
        } catch(e){ console.warn('WS failed', e); }
      })();

      document.getElementById('uploadBtn').onclick = uploadFile;
      document.getElementById('searchBtn').onclick = searchFiles;
      document.getElementById('logoutBtn').onclick = () => { localStorage.clear(); location.href='/login'; };

      window.downloadFile = downloadFile; window.deleteFile = deleteFile;
      fetchFiles();
    })();
</script>
</body>
</html>
